let t=0,dt=.05,paused=!0,canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d"),c=200,h=10;canvas.width=500,canvas.height=500;let Nx=canvas.width/h,Ny=canvas.height/h,drag=!1;canvas.addEventListener("mousedown",function(t){drag=!0}),canvas.addEventListener("mouseup",function(t){drag=!1}),canvas.addEventListener("mousemove",function(t){var e;drag&&(e=t.clientX-canvas.offsetLeft-canvas.clientLeft,t=t.clientY-canvas.offsetTop-canvas.clientTop,e=Math.floor(e/h),t=Math.floor(t/h),u[e][t]=1,draw())}),canvas.addEventListener("touchstart",function(t){drag=!0}),canvas.addEventListener("touchend",function(t){drag=!1}),canvas.addEventListener("touchmove",function(t){var e;t.preventDefault(),drag&&(e=t.touches[0].clientX-canvas.offsetLeft-canvas.clientLeft,t=t.touches[0].clientY-canvas.offsetTop-canvas.clientTop,e=Math.floor(e/h),t=Math.floor(t/h),u[e][t]=1,draw())});let u=[],ud=[],udd=[];for(let e=0;e<Nx;e++){u[e]=[],ud[e]=[],udd[e]=[];for(let t=0;t<Ny;t++)u[e][t]=.3,ud[e][t]=0,udd[e][t]=0}function resetDomain(){for(let e=t=0;e<Nx;e++)for(let t=0;t<Ny;t++)u[e][t]=.3,ud[e][t]=0,udd[e][t]=0;draw(),document.getElementById("text2").innerText=Math.floor(100*t)/100+""}function calculate(){let a;for(let e=0;e<Nx;e++)for(let t=0;t<Ny;t++)udd[e][t]=0,(a=0)!=e&&(udd[e][t]+=u[e-1][t],a++),e!=Nx-1&&(udd[e][t]+=u[e+1][t],a++),0!=t&&(udd[e][t]+=u[e][t-1],a++),t!=Ny-1&&(udd[e][t]+=u[e][t+1],a++),udd[e][t]-=a*u[e][t],udd[e][t]*=(c/h)**2}console.log(2*Nx*Ny+" states.");let jac=[];for(let e=0;e<2*Nx*Ny;e++){jac[e]=[];for(let t=0;t<2*Nx*Ny;t++)t==e+Nx*Ny?jac[e][t]=1:jac[e][t]=0}calculate();let udd0=[];for(let e=0;e<Nx;e++){udd0[e]=[];for(let t=0;t<Ny;t++)udd0[e][t]=udd[e][t]}for(let n=0;n<Nx;n++)for(let a=0;a<Ny;a++){u[n][a]+=.05,calculate(),u[n][a]-=.05;for(let e=0;e<Nx;e++)for(let t=0;t<Ny;t++)jac[Nx*Ny+e*Ny+t][n*Ny+a]=(udd[e][t]-udd0[e][t])/.05}let A=[];for(let e=0;e<Nx*Ny*2;e++){A[e]=[];for(let t=0;t<Nx*Ny*2;t++)A[e][t]=(e==t?1:0)-jac[e][t]*dt/2}function lu(a){let n,d;var o=a.length;for(let e=0;e<o-1;++e){n=a[e];for(let t=e+1;t<o;++t){d=a[t],d[e]/=a[e][e];for(let t=e+1;t<o;++t)d[t]-=d[e]*n[t]}}}function clamp(t){t=t<0?0:t;return 1<t?1:t}function draw(){for(let e=0;e<Nx;e++)for(let t=0;t<Ny;t++)ctx.fillStyle="rgb("+255*clamp(1.5-Math.abs(4*u[e][t]-3))+","+255*clamp(1.5-Math.abs(4*u[e][t]-2))+","+255*clamp(1.5-Math.abs(4*u[e][t]-1))+")",ctx.beginPath(),ctx.rect(e*h,t*h,h,h),ctx.fill()}lu(A);let b=[];for(let t=0;t<2*Nx*Ny;t++)b[t]=0;function run(){if(!paused){calculate(),draw();for(let e=0;e<Nx;e++)for(let t=0;t<Ny;t++)b[e*Ny+t]=ud[e][t]*dt,b[Nx*Ny+e*Ny+t]=udd[e][t]*dt;for(let e=0;e<2*Nx*Ny;e++)for(let t=e-1;0<=t;t--)b[e]-=A[e][t]*b[t];for(let e=2*Nx*Ny-1;0<=e;e--){for(let t=e+1;t<2*Nx*Ny;t++)b[e]-=A[e][t]*b[t];b[e]/=A[e][e]}for(let e=0;e<Nx;e++)for(let t=0;t<Ny;t++)u[e][t]+=b[e*Ny+t],ud[e][t]+=b[Nx*Ny+e*Ny+t];t+=dt,document.getElementById("text2").innerText=Math.floor(100*t)/100+""}}setInterval(run,1e3*dt);
