function gauss(t,e,s){let i,r,a,n,h,o,l,c,u,g,f,d;var p=e.length;for(h=0,a=0;a<p-1;++a){for(d=Math.abs(t[a][a]),n=a,i=a+1;i<p;i++)u=Math.abs(t[i][a]),u>d&&(d=u,n=i);if(n!=a)for(h+=1,f=e[a],e[a]=e[n],e[n]=f,r=a;r<p;r++)g=t[a][r],t[a][r]=t[n][r],t[n][r]=g;for(o=t[a],l=e[a],i=a+1;i<p;++i){for(u=t[i][a]/t[a][a],c=t[i],r=a+1;r<p;++r)c[r]=c[r]-u*o[r];e[i]=e[i]-u*l}}for(r=0;r<p;++r){for(a=p-r-1,s[a]=e[a],i=a+1;i<p;++i)s[a]=s[a]-t[a][i]*s[i];s[a]=s[a]/t[a][a]}}class Independent{constructor(t,e){solver.jacobIndepList.push(this),this.obj=t,this.varName=e,this.x=0,this.xRef=1,this.xBase=0,this.dxLimit=.1,this.perturbation=.01}getXModel(){this.x=this.obj[this.varName]}setXModel(){this.obj[this.varName]=this.x}setDx(t){this.x+=t,this.setXModel()}setX(t){this.x=t,this.setXModel()}perturb(){var t=this.calcPerturbation();return this.setDx(t),t}setBaseline(){this.getXModel(),this.xBase=this.x}restoreBaseValue(){this.setX(this.xBase)}calcPerturbation(){return this.perturbation*this.xRef}calcDxLimit(){return this.dxLimit*this.xRef}}class Dependent{constructor(t,e){solver.jacobDepList.push(this),this.obj=t,this.varName=e,this.yRef=1,this.tolerance=1e-4,this.error=0,this.integrator=!1}updateErrors(){var t=this.obj[this.varName];this.error="function"==typeof t?this.obj[this.varName]():t}isConverged(){return Math.abs(this.error)<=this.tolerance}almostConverged(t){return t<1&&(t=1),Math.abs(this.error)<=t*this.tolerance}}class Element{constructor(){solver.executionSequence.push(this)}animate(){}calculate(){}}class Jacobian{constructor(t){this.parentSolver=t,this.Jsquare=[]}initializeMatrices(t,s){this.Jsquare=[];for(let e=0;e<t;e++){this.Jsquare[e]=[];for(let t=0;t<s;t++)this.Jsquare[e][t]=0}}calcMatrixColumn(t,e,s){var i,r,a;for([r,a]of this.parentSolver.jacobDepList.entries())a.updateErrors(),i=a.error-s[r],this.Jsquare[r][t]=r==t&&a.integrator?1:0,this.Jsquare[r][t]-=i/e*this.parentSolver.timeStep/2}getBasePoint(t){for(var[e,s]of this.parentSolver.jacobDepList.entries())t[e]=s.error;for(const i of this.parentSolver.jacobIndepList)i.setBaseline()}generateMatrix(){var t,e=[],s=this.parentSolver.jacobIndepList.length,i=this.parentSolver.jacobDepList.length;if(s!=i&&console.log(" Attempted to generate a Jacobian matrix with unequal number of Independents and Dependents"),this.initializeMatrices(i,s),0!=s||0!=i){this.getBasePoint(e);for(var[r,a]of this.parentSolver.jacobIndepList.entries())t=a.perturb(),this.parentSolver.runExecutionSequence(),this.calcMatrixColumn(r,t,e),a.restoreBaseValue()}}calcDx(){gauss(this.Jsquare,this.parentSolver.error,this.parentSolver.dxUnlim)}}class Solver{constructor(){this.jacobian=new Jacobian(this),this.jacobIndepList=[],this.jacobDepList=[],this.executionSequence=[],this.maxIterations=10,this.error=[],this.dxUnlim=[],this.iterationCounter=0,this.timeStep=.01}runExecutionSequence(){for(const t of this.executionSequence)t.calculate(),t.animate()}updateErrors(){for(var[t,e]of this.jacobDepList.entries())e.updateErrors(),this.error[t]=e.error*this.timeStep}checkConvergence(){var t=!0;for(const e of this.jacobDepList)e.isConverged()||(t=!1);return t}updateIndependents(){for(var[t,e]of this.jacobIndepList.entries())e.setDx(this.dxUnlim[t])}run(){for(this.iterationCounter=0;this.iterationCounter<this.maxIterations;this.iterationCounter++){if(this.runExecutionSequence(),this.updateErrors(),this.checkConvergence())return!0;this.jacobian.generateMatrix(),this.jacobian.calcDx(),this.updateIndependents()}return!1}}class Flange{constructor(){this.x=0,this.y=0,this.fx=0,this.fy=0}}class Mount extends Element{constructor(){super(),this.flange=new Flange,this.svg=document.createElementNS(svgNS,"rect"),this.svg.setAttribute("fill","#F33"),this.svg.setAttribute("width",20),this.svg.setAttribute("height",20),diagram.appendChild(this.svg)}animate(){this.svg.setAttribute("x",this.flange.x-10),this.svg.setAttribute("y",this.flange.y-10)}}class Mass extends Element{constructor(e){super(),this.flange=[];for(let t=0;t<e;t++)this.flange.push(new Flange);this.m=0.1,this.r=10,this.x=0,this.y=0,this.vx=0,this.vy=0,this.ax=0,this.ay=0,this.ind_vx=new Independent(this,"x"),this.dep_vx=new Dependent(this,"vx"),this.dep_vx.integrator=!0,this.ind_vy=new Independent(this,"y"),this.dep_vy=new Dependent(this,"vy"),this.dep_vy.integrator=!0,this.ind_ax=new Independent(this,"vx"),this.dep_ax=new Dependent(this,"getax"),this.dep_ax.integrator=!0,this.ind_ay=new Independent(this,"vy"),this.dep_ay=new Dependent(this,"getay"),this.dep_ay.integrator=!0,this.svg=document.createElementNS(svgNS,"circle"),this.svg.setAttribute("fill","#7AF"),diagram.appendChild(this.svg)}animate(){this.svg.setAttribute("r",this.r),this.svg.setAttribute("cx",this.x),this.svg.setAttribute("cy",this.y)}calculate(){for(let t=0;t<this.flange.length;t++)this.flange[t].x=this.x,this.flange[t].y=this.y}getax(){let e=0;for(let t=0;t<this.flange.length;t++)e+=this.flange[t].fx;return e/this.m}getay(){let e=0;for(let t=0;t<this.flange.length;t++)e+=this.flange[t].fy;return e/this.m+0}}class Spring extends Element{flange_a;flange_b;constructor(){super(),this.k=10,this.svg=document.createElementNS(svgNS,"path"),this.svg.setAttribute("d","M 10,50 L 20,50 L 25,40 L 35,60 L 45,40 L 55,60 L 65,40 L 75,60 L 85,40 L 95,60 L 105,40 L 115,60 L 120,50 L 130,50"),this.svg.setAttribute("fill","none"),this.svg.setAttribute("stroke","#FFF"),diagram.appendChild(this.svg)}animate(){var t=Math.sqrt((this.flange_a.x-this.flange_b.x)**2+(this.flange_a.y-this.flange_b.y)**2)/120,e=10*t,s=130*t,i=this.flange_a.x,r=this.flange_a.y,a=this.flange_b.x,n=this.flange_b.y,h=[0,0,0,0,0,0];let o=[];o[0]=[e,0,50,0,1,0],o[1]=[0,e,0,50,0,1],o[2]=[s,0,50,0,1,0],o[3]=[0,s,0,50,0,1],o[4]=[1,0,0,-1,0,0],o[5]=[0,1,1,0,0,0],gauss(o,[i,r,a,n,0,0],h),this.svg.setAttribute("transform",`matrix(${h[0]},${h[1]},${h[2]},${h[3]},${h[4]},${h[5]}) scale(${t},1)`)}calculate(){var t=this.flange_a.x-this.flange_b.x,e=this.flange_a.y-this.flange_b.y;this.flange_a.fx=-this.k*t,this.flange_a.fy=-this.k*e,this.flange_b.fx=this.k*t,this.flange_b.fy=this.k*e}}
